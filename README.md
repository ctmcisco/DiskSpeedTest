# DiskSpeedTest

Automate the [DiskSpd](https://github.com/microsoft/diskspd) utility to run iterative IO performance tests.  

_**Use at your own risk, DiskSpd can be destructive.**_

## License

![GitHub](https://img.shields.io/github/license/ptr727/DiskSpeedTest)

## Usage

- Clone a copy of the code from [GitHub](https://github.com/ptr727/DiskSpeedTest), and open the project with Visual Studio or Visual Studio Code.
- Download [DiskSpd](https://aka.ms/diskspd), and place the `diskspd.exe` binary in the path or the working directory.
- Create a JSON config file with the required test parameters.
- Compile and run the code, specifying the path to the JSON config on the commandline, e.g. `DiskSpeedTest.exe DiskSpeedTest.json`.
- Analyze the CSV results.

## Config JSON File

```json
{
    // Output CSV file
    "resultsfile": "C:\\Temp\\SpeedTestResults.csv",
    // Test targets, specify full path and filename, path must exist
    "testtargets": [
        "C:\\Temp\\SpeedTestDataFile.dat",
        "\\\\Server\\Share\\Path\\SpeedTestDataFile.dat"
    ],
    // File size of test target in bytes
    "testtargetsize": 68719476736,
    // Block size in bytes, automatically generated by doubling the beginning value until the end size is reached
    "blocksizebegin": 4096,
    "blocksizeend": 2097152,
    // Warmup time in seconds, do IO but don't use the values in computed results
    "warmuptime": 30,
    // Test time in seconds
    "testtime": 120,
    // Time to rest between test runs
    "resttime": 0
}
```

## Output CSV File

```
UTC, FileName, FileSize, BlockSize, WriteRatio, ThreadCount, OutstandingOperations, WarmupTime, TestTime, Bytes, IOS
```

## Notes

- I created the utility to help [troubleshoot](https://blog.insanegenius.com/2019/06/10/unraid-in-production-a-bit-rough-around-the-edges-and-terrible-smb-performance/) UnRaid v6.7.2 SMB performance issues.
- While retesting I encountered IO failures with Unraid v6.8.1, appears to be with block sizes 512KB, 1MB, and 2MB, no such failures when using v6.7.2.

```shell
diskspd.exe -w50 -b524288 -F2 -o8 -W30 -d120 -r -Rxml -Srw \\Server-2\CacheSpeedTest\SpeedTestDataFile.dat
error during overlapped IO operation (error code: 59)
error during overlapped IO operation (error code: 59)
There has been an error during threads execution
Error generating I/O requests

diskspd.exe -w50 -b1048576 -F2 -o8 -W30 -d120 -r -Rxml -Srw \\Server-2\CacheSpeedTest\SpeedTestDataFile.dat
error during overlapped IO operation (error code: 59)
error during overlapped IO operation (error code: 59)
There has been an error during threads execution
Error generating I/O requests

diskspd.exe -w0 -b2097152 -F2 -o8 -W30 -d120 -r -Rxml -Srw \\Server-2\CacheSpeedTest\SpeedTestDataFile.dat
Error opening file: \\Server-2\CacheSpeedTest\SpeedTestDataFile.dat [64]
There has been an error during threads execution
Error generating I/O requests
Failed to run test

diskspd.exe -w50 -b2097152 -F2 -o8 -W30 -d120 -r -Rxml -Srw \\Server-2\CacheSpeedTest\SpeedTestDataFile.dat
error during overlapped IO operation (error code: 59)
error during overlapped IO operation (error code: 59)
There has been an error during threads execution
Error generating I/O requests
```
